<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>RC</title>
	<style>
		* {
			font-family: arial;
		}
		input, textarea, #encryptedText {
			margin: 2em;
		}
	</style>
	<script>

	/*
	*  test case: k=Key, t=Plaintext, ks=eb9f7781b734ca72a719..., ct=BBF316E8D940AF0AD3
	*  test case: k=Secret. t=Attack at dawn, ks=04d46b053ca87b59..., ct=45A01F645FC35B383552544B9BF5

	*/

		/*
		* Button Handler
		*/
		function onEncryptBtnClick(){
				var k = document.getElementById("password").value;
				var t = document.getElementById("plainText").value;
				document.getElementById("encryptedText").innerHTML = encrypt(k,t);
		}

		/**
		* Encrypt text using key
		* @param string k - secret key
		* @param string t - plain text
		* @return string
		*/
		function encrypt(k,t) {
			document.getElementById("encryptedText").innerHTML = "Hello World";

			//check 1 <= k <= 256
			if(k.length < 1 || k.length >256){
				alert("key length must be 1-256");
				return;
			}


			//KSA - Key Scheduling Algorithm
			//==============================
			//create 8-by-8 S-Box, fill it with numbers from 0 to 255
			var i,j;
			var sbox = [];//vector
			for(i=0;i<256;i++){
				sbox[i]=i;
			}

			//create 8-by-8 seed box, fill it up with the key
			var kbox = [];
			var keyIdx = 0;
			for(i=0;i<256;i++){
				//keyIdx = keyIdx == k.length ? 0 : keyIdx++;
				if(keyIdx==k.length){
					keyIdx = 0;
				}
				kbox[i] = k.substr(keyIdx,1);
				keyIdx++;
			}
			debugger;

			//randomize S-Box
			//for each element in S-Box
			var x,y,z,a,b,temp;
			for(i=0;i<256;i++){
				x = sbox[i];//S-Box position
				y = kbox[i];//keybox position (character)
				z = y.charCodeAt(0);//ascii code for keybox position
				a = x + z;//add ascii code for keybox position to s-box position
				b = a % 256;//check the sum doesn't exceed 256 (calculate mod)
				//exchange S-Box position i to S-Box position at b
				temp = sbox[i];
				sbox[i] = sbox[b];
				sbox[b] = temp;
			} 
			console.dir(sbox);//final S vector

			//PRGA - Pseudo-Random Generation Algorithm
			//=========================================
			//Generate key stream (same lenght than the message)
			//for each letter in plaintext:
			i = 0;//counter i
			j = 0;//counter j
			//debugger;
			var ksc;//key stream character
			var ks = [];//key stream 
			for(var l=0;l<t.length;l++){
				i = (i+1) % 256;
				j = (j + sbox[i]) % 256;
				//exchange sbox[i] with sbox[j]
				temp = sbox[i];
				sbox[i] = sbox[j];
				sbox[j] = temp;
				//caracter en el keystream:
				ksc = (sbox[i] + sbox[j]) % 256;

				//add ksc to key stream
				ks.push(sbox[ksc]);
			}
			console.log(t);//string plain text
			console.log(ks);//array key stream


			//convert string plaintext to array
			t = t.split("");
			for(i=0;i<t.length;i++){
				console.log(t[i]);
				//convert each letter in plaintext vector to ascii code
				t[i] = t[i].charCodeAt(0);
			}

			//plaintext xor key stream
			var ct = [];//cipher text
			for(i=0;i<t.length;i++){
				ct.push(t[i]^ks[i]);
			}

			//convert ct to hexa
			for(i=0;i<ct.length;i++){
				ct[i] = ct[i].toString(16);
			}

			console.log(ct);
			return ct;
		}

		/**
		* Decrypt text using key
		* @param string k - secret key
		* @param string ct - cipher text
		* @return string
		*/
		function decrypt(k, ct) {
			//document.rc4.text.value=(rc4(document.rc4.key.value,base64ToText(document.rc4.text.value)))
		}
	</script>
</head>
<body>
	<h2>Simple RC4 stream cipher in javascript</h2>
	<br>
	<form name="rc4">
		<input type="text" id="password" placeholder="Password">
		<br>
		<textarea id="plainText" placeholder="Type here your plaintext" rows="5"></textarea>
		<br>
		<input type="button" id="btn-encrypt" value="Encrypt" onclick="onEncryptBtnClick()"><input type="button" id="btn-decrypt" value="Decrypt">
	</form>
	Encrypted text:
	<div id="encryptedText"></div>
	
</body>
</html>